<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Isthmus ¬∑ ChatAgent</title>

  <!-- ChatKit runtime -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>

  <!-- Verificaci√≥n de dominio (tu domain_pk) -->
  <meta name="chatkit:domain_public_key" content="domain_pk_68e7da3b8b38819099c41f6a597d5cdf00560b7a3fd09ef4" />

  <style>
    :root { --ck-blue:#0f5ea8; --ck-bg:#f6f8fb; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:var(--ck-bg); }
    #chat-container {
      position: fixed; right: 20px; bottom: 88px; width: 360px; height: 600px; display:none;
      background:#fff; border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,.25); overflow:hidden; z-index: 9998;
    }
    #chat-launcher {
      position: fixed; right: 20px; bottom: calc(20px + env(safe-area-inset-bottom, 0px)); width:56px; height:56px; border-radius:50%;
      border:none; background:var(--ck-blue); color:#fff; font-size:22px; cursor:pointer; z-index: 9999;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
      transition: all .18s ease;
    }
    #status {
      position: fixed; left: 20px; bottom: calc(20px + env(safe-area-inset-bottom, 0px)); padding:8px 12px; border-radius:10px; background:#fff;
      box-shadow:0 6px 20px rgba(0,0,0,.12); color:#222; font-size:12px; display:none; z-index:9999;
    }

    /* Modo m√≥vil */
    @media (max-width:480px){
      #chat-container{
        width:100vw; height:70vh; right:0; left:0; bottom:0; border-radius:0;
      }
      #chat-launcher{
        right:16px; bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      }
      /* Cuando el chat est√° abierto en m√≥vil, mueve el bot√≥n a la izquierda y hazlo un poco m√°s peque√±o */
      .chat-open #chat-launcher{
        left:16px; right:auto; bottom: calc(16px + env(safe-area-inset-bottom, 0px));
        width:48px; height:48px; font-size:20px;
      }
    }

    /* Tambi√©n aplica el movimiento a la izquierda en pantallas peque√±as/medianas si quieres evitar solapamiento */
    @media (max-width:768px){
      .chat-open #chat-launcher{
        left:16px; right:auto;
      }
    }
  </style>
</head>
<body>
  <!-- Tu p√°gina puede ir aqu√≠‚Ä¶  -->

  <!-- Contenedor del chat + bot√≥n -->
  <div id="chat-container" aria-hidden="true"></div>
  <button id="chat-launcher" aria-label="Abrir chat" title="Abrir chat">üí¨</button>
  <div id="status" role="status" aria-live="polite"></div>

  <script>
  (function () {
    // Endpoints de tu backend
    const SESSION_URL = "https://isthmus-production.up.railway.app/api/chatkit/session";
    const TOOLS_BASE  = "https://isthmus-production.up.railway.app/tools";

    // Utilidad: mini aviso no intrusivo
    const statusEl = document.getElementById("status");
    function toast(msg, ms=2600){
      statusEl.textContent = msg;
      statusEl.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> statusEl.style.display="none", ms);
    }

    // ID de dispositivo estable en el navegador
    const deviceIdKey = "ck_device_id";
    let deviceId = localStorage.getItem(deviceIdKey);
    if (!deviceId) {
      deviceId = (self.crypto?.randomUUID && crypto.randomUUID()) || String(Date.now());
      localStorage.setItem(deviceIdKey, deviceId);
    }

    // --- Client tools: el agente llamar√° a estas funciones ---
    // Versi√≥n TOLERANTE A ERRORES (no lanza excepciones; devuelve { ok:false, ... } en fallos)
    async function postJSON(url, payload){
      try {
        const r = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          // No rompemos el UI; devolvemos el error al agente
          return { ok:false, http_status:r.status, ...data };
        }
        return data;
      } catch (e) {
        return { ok:false, error:"client_fetch_error" };
      }
    }

    const clientTools = {
      // create_lead({ full_name, email, phone, program_interest, language, ... })
      create_lead: async (args) => postJSON(TOOLS_BASE + "/create_lead", args),

      // schedule_visit({ modality, preferred_dt_local, contact:{ name,email,phone }, program_interest, notes })
      schedule_visit: async (args) => postJSON(TOOLS_BASE + "/schedule_visit", args),
    };

    // Obtener token ef√≠mero SIEMPRE fresco
    async function getClientSecret() {
      const res = await fetch(SESSION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: deviceId })
      });
      if (!res.ok) {
        toast("No se pudo iniciar el chat. Intenta de nuevo.");
        throw new Error("No se pudo crear la sesi√≥n");
      }
      const data = await res.json();
      return data.client_secret; // ek_...
    }

    // Montaje cuando el runtime est√© cargado
    function mountWhenReady(){
      if (!window.ChatKit || !window.ChatKit.create) {
        requestAnimationFrame(mountWhenReady);
        return;
      }

      const container = document.getElementById("chat-container");
      const launcher  = document.getElementById("chat-launcher");
      let mounted = false;

      const control = window.ChatKit.create({
        api: { getClientSecret },
        tools: clientTools
      });

      launcher.onclick = () => {
        if (!mounted) {
          window.ChatKit({ control, className: "h-[600px] w-[360px]" }).mount(container);
          mounted = true;
        }
        const show = container.style.display !== "block";
        container.style.display = show ? "block" : "none";
        container.setAttribute("aria-hidden", String(!show));
        // Marca el body para que el CSS mueva el bot√≥n en m√≥vil cuando el chat est√© abierto
        document.body.classList.toggle("chat-open", show);
        launcher.setAttribute("aria-label", show ? "Cerrar chat" : "Abrir chat");
        launcher.setAttribute("title", show ? "Cerrar chat" : "Abrir chat");
      };
    }

    // Evita tokens viejos cuando recargas con cach√©
    if ("serviceWorker" in navigator) {
      // nada obligatorio; solo recordatorio si usas SW
    }

    mountWhenReady();

    // Info √∫til en consola (solo para debug local; puedes quitarlo)
    console.log("[Isthmus Chat] deviceId:", deviceId);
  })();
  </script>
</body>
</html>
