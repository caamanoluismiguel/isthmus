<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asesor de Admisiones 路 ISTHMUS</title>

  <!-- ChatKit runtime -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>
  <!-- Verificaci贸n de dominio (si aplica) -->
  <meta name="chatkit:domain_public_key" content="domain_pk_68e7da3b8b38819099c41f6a597d5cdf00560b7a3fd09ef4" />

  <!-- Favicon inline para evitar 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%23111"/><text x="32" y="42" font-size="28" text-anchor="middle" fill="white"></text></svg>' />

  <style>
    :root{ --bg:#f6f8fb; --ink:#0b2b3c; }
    *{ box-sizing:border-box }
    html, body{ height:100%; margin:0 }
    body{
      background:var(--bg);
      color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    }
    .page{ min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px; }
    .hint{ font-size:16px; opacity:.7; text-align:center; user-select:none; }

    /* Bot贸n flotante */
    #chat-launcher{
      position:fixed; right:20px; bottom:20px;
      width:56px; height:56px; border-radius:50%;
      border:none; cursor:pointer; z-index:9999;
      background:#111; color:#fff; font-size:22px; line-height:1;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
    }
    #chat-launcher:focus{ outline:3px solid rgba(15,94,168,.4); outline-offset:2px; }

    /* Contenedor del chat */
    #chat-container{
      position:fixed; right:20px; bottom:88px;
      width:360px; height:600px; z-index:9998; display:none;
      background:#fff; border-radius:12px; overflow:hidden;
      box-shadow:0 16px 36px rgba(0,0,0,.28);
    }
    @media (max-width:480px){
      #chat-container{ right:0; left:0; bottom:0; width:100vw; height:70vh; border-radius:0; }
    }
  </style>
</head>
<body>
  <noscript>Activa JavaScript para usar el chat.</noscript>

  <div class="page">
    <div class="hint" id="boot-hint">P谩gina lista. Toca el bot贸n  para abrir el chat.</div>
  </div>

  <div id="chat-container" aria-hidden="true"></div>
  <button id="chat-launcher" aria-label="Abrir chat de admisiones" title="Chatear"></button>

  <script>
    (function(){
      // URL de tu API en Railway
      var SESSION_URL = "https://isthmus-production.up.railway.app/api/chatkit/session";

      // ID por dispositivo (persistente)
      var KEY = "ck_device_id";
      var deviceId = null;
      try {
        deviceId = localStorage.getItem(KEY);
        if(!deviceId){
          deviceId = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : (String(Date.now()) + "-" + Math.random().toString(36).slice(2));
          localStorage.setItem(KEY, deviceId);
        }
      } catch(_) {
        deviceId = String(Date.now()) + "-" + Math.random().toString(36).slice(2);
      }

      function whenReady(fn){
        if (window.ChatKit) return fn();
        setTimeout(function(){ whenReady(fn); }, 80);
      }

      function getClientSecret(){
        return fetch(SESSION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: deviceId })
        }).then(function(r){
          if(!r.ok){ return r.text().then(function(t){ throw new Error("No se pudo crear la sesi贸n: " + r.status + " " + t); }); }
          return r.json();
        }).then(function(json){
          return json.client_secret;
        });
      }

      document.addEventListener("DOMContentLoaded", function(){
        var container = document.getElementById("chat-container");
        var fab = document.getElementById("chat-launcher");
        var mounted = false;
        var open = false;
        var instance = null;

        whenReady(function(){
          fab.addEventListener("click", function(){
            if(!mounted){
              try{
                instance = window.ChatKit({
                  api: { getClientSecret: getClientSecret },
                  className: "h-[600px] w-[360px]"
                });
                instance.mount(container);
                mounted = true;
              } catch(e){
                console.warn("Error al montar ChatKit:", e);
                container.style.display = "block";
                container.innerHTML = "<div style='padding:16px;font-family:ui-sans-serif'><strong>No se pudo cargar el chat.</strong><br/>Revisa la consola y la URL de sesi贸n.</div>";
                return;
              }
            }
            open = !open;
            container.style.display = open ? "block" : "none";
            container.setAttribute("aria-hidden", String(!open));
          });
        });
      });
    })();
  </script>
</body>
</html>





