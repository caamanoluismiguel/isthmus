<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Demo · Isthmus Admissions Agent</title>

  <!-- Verificación de dominio (del panel de OpenAI) -->
  <meta name="chatkit:domain_public_key" content="domain_pk_68e7da3b8b38819099c41f6a597d5cdf00560b7a3fd09ef4">

  <!-- Runtime de ChatKit: registra <openai-chatkit> como Web Component -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>

  <style>
    /* Botón flotante y contenedor del chat */
    #ck-fab {
      position: fixed; right: 20px; bottom: 20px; z-index: 9999;
      width: 56px; height: 56px; border-radius: 50%; border: none; cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,.2); background: #0f5ea8; color: #fff; font-size: 22px;
    }
    #ck-shell {
      position: fixed; right: 20px; bottom: 88px; z-index: 9998;
      width: 360px; height: 600px; display: none;
      background: #fff; border-radius: 12px; overflow: hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    @media (max-width: 480px){
      #ck-shell { width: 100vw; height: 70vh; right: 0; left: 0; bottom: 0; border-radius: 0; }
    }
    /* Asegura que el web component ocupe el shell */
openai-chatkit {
  display: block;
  width: 100%;
  height: 100%;
  min-height: 100%;
}
  </style>
</head>
<body>
  <!-- Tu página puede tener contenido normal aquí… -->

  <!-- Contenedor del chat + botón -->
  <div id="ck-shell" aria-hidden="true">
    <!-- El web component se inserta aquí -->
    <openai-chatkit id="isthmus-chat" class="h-[600px] w-[360px]"></openai-chatkit>
  </div>
  <button id="ck-fab" aria-label="Abrir chat">💬</button>

  <script>
    (function(){
      const SESSION_URL = "https://isthmus-production.up.railway.app/api/chatkit/session"; // ← tu endpoint en Railway
      const deviceIdKey = "ck_device_id";
      let deviceId = localStorage.getItem(deviceIdKey);
      if (!deviceId) { deviceId = crypto.randomUUID(); localStorage.setItem(deviceIdKey, deviceId); }

      const shell = document.getElementById("ck-shell");
      const chatEl = document.getElementById("isthmus-chat");
      const fab   = document.getElementById("ck-fab");
      let configured = false;

      // Pide/renueva el client_secret al backend (patrón recomendado)
      async function getClientSecret(currentClientSecret){
        const res = await fetch(SESSION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          // Si tu server necesita el workflow_id explícito, añádelo aquí:
          body: JSON.stringify({
            user: deviceId,
            currentClientSecret // para refresh si aplica
            // workflow: { id: "wf_68e7cc18d10c8190a69b17e589c1899e01de395587bb64d1" }
          })
        });
        if (!res.ok) {
          const text = await res.text().catch(()=> "");
          throw new Error("No se pudo obtener client_secret: " + res.status + " " + text);
        }
        const data = await res.json();
        return data.client_secret;
      }

      // Espera a que el Web Component esté registrado por el runtime
      async function ensureComponentReady(){
        if (window.customElements && customElements.whenDefined) {
          await customElements.whenDefined('openai-chatkit');
        } else {
          // Fallback sencillo: esperar unos ms al script async
          await new Promise(r => setTimeout(r, 400));
        }
      }

      async function mountIfNeeded(){
        if (configured) return;
        await ensureComponentReady();

        // Configura el componente (web component) con el método de auth
        // Puedes pasar también opciones de UI/idioma (locale) y theming.
        chatEl.setOptions({
          api: { getClientSecret },         // ← patrón oficial
          locale: "es",
          startScreen: {
            title: "Asesor de Admisiones · ISTHMUS",
            subtitle: "¿Cómo te llamas? Puedo ayudarte con programas, requisitos, visitas y envío de costos por correo."
          }
        });
        configured = true;
      }

      fab.onclick = async () => {
        try {
          await mountIfNeeded();
          const show = shell.style.display !== "block";
          shell.style.display = show ? "block" : "none";
          shell.setAttribute("aria-hidden", String(!show));
        } catch (err) {
          console.error(err);
          alert("No pude iniciar el chat. Revisa la consola del navegador.");
        }
      };
    })();
  </script>
</body>
</html>






