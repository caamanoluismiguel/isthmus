<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Isthmus ¬∑ ChatAgent</title>

  <!-- ChatKit runtime -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>

  <!-- Verificaci√≥n de dominio -->
  <meta name="chatkit:domain_public_key" content="domain_pk_68e7da3b8b38819099c41f6a597d5cdf00560b7a3fd09ef4" />

  <style>
    :root { --ck-blue:#0f5ea8; --ck-bg:#f6f8fb; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:var(--ck-bg); }

    /* Contenedor del chat */
    #chat-container{
      position: fixed; right: 20px; bottom: 88px; width: 360px; height: 600px; display:none;
      background:#fff; border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,.25); overflow:hidden; z-index: 9998;
    }

    /* Bot√≥n flotante */
    #chat-launcher{
      position: fixed; right: 20px; bottom: calc(20px + env(safe-area-inset-bottom, 0px));
      width:56px; height:56px; border-radius:50%; border:none; background:var(--ck-blue);
      color:#fff; font-size:22px; cursor:pointer; z-index: 9999; box-shadow: 0 6px 20px rgba(0,0,0,.25);
      transition: transform .18s ease, opacity .18s ease;
    }

    /* Bot√≥n de cerrar dentro del chat */
    #chat-close{
      position:absolute; top:8px; right:8px; width:36px; height:36px; border:none; border-radius:9999px;
      background:rgba(0,0,0,.5); color:#fff; font-size:20px; line-height:36px; text-align:center; cursor:pointer;
      z-index:10000; display:none;
    }
    .chat-open #chat-close{ display:block; }

    #status{
      position: fixed; left: 20px; bottom: calc(20px + env(safe-area-inset-bottom, 0px)); padding:8px 12px;
      border-radius:10px; background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.12); color:#222; font-size:12px;
      display:none; z-index:9999;
    }

    /* M√≥vil */
    @media (max-width:480px){
      #chat-container{ width:100vw; height:70vh; right:0; left:0; bottom:0; border-radius:0; }
      /* Oculta el bot√≥n flotante cuando el chat est√° abierto para no tapar ‚ÄúEnviar‚Äù */
      .chat-open #chat-launcher{ display:none; }
      /* Extra: al estar cerrado, el bot√≥n flotante queda abajo a la derecha pero con safe-area */
      #chat-launcher{ right:16px; bottom: calc(16px + env(safe-area-inset-bottom, 0px)); }
    }
  </style>
</head>
<body>
  <!-- Tu p√°gina‚Ä¶ -->

  <!-- Chat -->
  <div id="chat-container" aria-hidden="true">
    <button id="chat-close" aria-label="Cerrar chat" title="Cerrar">√ó</button>
  </div>
  <button id="chat-launcher" aria-label="Abrir chat" title="Abrir chat">üí¨</button>
  <div id="status" role="status" aria-live="polite"></div>

  <script>
  (function () {
    const SESSION_URL = "https://isthmus-production.up.railway.app/api/chatkit/session";
    const TOOLS_BASE  = "https://isthmus-production.up.railway.app/tools";

    const statusEl = document.getElementById("status");
    function toast(msg, ms=2600){
      statusEl.textContent = msg;
      statusEl.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> statusEl.style.display="none", ms);
    }

    // ID estable por navegador
    const deviceIdKey = "ck_device_id";
    let deviceId = localStorage.getItem(deviceIdKey);
    if (!deviceId) {
      deviceId = (self.crypto?.randomUUID && crypto.randomUUID()) || String(Date.now());
      localStorage.setItem(deviceIdKey, deviceId);
    }

    // --- Client tools tolerantes a errores ---
    async function postJSON(url, payload){
      try {
        const r = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) return { ok:false, http_status:r.status, ...data };
        return data;
      } catch {
        return { ok:false, error:"client_fetch_error" };
      }
    }

    const clientTools = {
      create_lead:    (args) => postJSON(TOOLS_BASE + "/create_lead", args),
      schedule_visit: (args) => postJSON(TOOLS_BASE + "/schedule_visit", args)
    };

    async function getClientSecret() {
      const res = await fetch(SESSION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: deviceId })
      });
      if (!res.ok) {
        toast("No se pudo iniciar el chat. Intenta de nuevo.");
        throw new Error("No se pudo crear la sesi√≥n");
      }
      const data = await res.json();
      return data.client_secret;
    }

    function mountWhenReady(){
      if (!window.ChatKit || !window.ChatKit.create) {
        requestAnimationFrame(mountWhenReady);
        return;
      }

      const container = document.getElementById("chat-container");
      const launcher  = document.getElementById("chat-launcher");
      const closer    = document.getElementById("chat-close");
      let mounted = false;

      const control = window.ChatKit.create({
        api: { getClientSecret },
        tools: clientTools
      });

      function setOpen(open){
        if (!mounted && open) {
          window.ChatKit({ control, className: "h-[600px] w-[360px]" }).mount(container);
          mounted = true;
        }
        container.style.display = open ? "block" : "none";
        container.setAttribute("aria-hidden", String(!open));
        document.body.classList.toggle("chat-open", open);
        launcher.setAttribute("aria-label", open ? "Cerrar chat" : "Abrir chat");
        launcher.setAttribute("title", open ? "Cerrar chat" : "Abrir chat");
      }

      launcher.addEventListener("click", () => setOpen(container.style.display !== "block"));
      closer  .addEventListener("click", () => setOpen(false));
    }

    if ("serviceWorker" in navigator) { /* opcional */ }
    mountWhenReady();
  })();
  </script>
</body>
</html>
