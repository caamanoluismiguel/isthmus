<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Isthmus Â· ChatAgent</title>

  <!-- ChatKit runtime -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>

  <!-- VerificaciÃ³n de dominio (tu domain_pk) -->
  <meta name="chatkit:domain_public_key" content="domain_pk_68e7da3b8b38819099c41f6a597d5cdf00560b7a3fd09ef4" />

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:#f6f8fb; }
    #chat-container {
      position: fixed; right: 20px; bottom: 88px; width: 360px; height: 600px; display:none;
      background:#fff; border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,.25); overflow:hidden; z-index: 9998;
    }
    #chat-launcher {
      position: fixed; right: 20px; bottom: 20px; width:56px; height:56px; border-radius:50%;
      border:none; background:#0f5ea8; color:#fff; font-size:22px; cursor:pointer; z-index: 9999;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    @media (max-width:480px){ #chat-container{ width:100vw; height:70vh; right:0; left:0; bottom:0; border-radius:0; } }
  </style>
</head>
<body>
  <!-- Tu pÃ¡gina puede ir aquÃ­â€¦  -->

  <!-- Contenedor del chat + botÃ³n -->
  <div id="chat-container" aria-hidden="true"></div>
  <button id="chat-launcher" aria-label="Abrir chat">ðŸ’¬</button>

  <script>
  (function () {
    const SESSION_URL = "https://isthmus-production.up.railway.app/api/chatkit/session";
    const TOOLS_BASE  = "https://isthmus-production.up.railway.app/tools";

    // ID de dispositivo estable en el navegador
    const deviceIdKey = "ck_device_id";
    let deviceId = localStorage.getItem(deviceIdKey);
    if (!deviceId) {
      deviceId = (self.crypto?.randomUUID && crypto.randomUUID()) || String(Date.now());
      localStorage.setItem(deviceIdKey, deviceId);
    }

    // --- Client tools: el agente llamarÃ¡ a estas funciones ---
    async function postJSON(url, payload){
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!r.ok) {
        const txt = await r.text().catch(()=> "");
        throw new Error("Tool call failed: " + r.status + " " + txt);
      }
      return r.json().catch(()=> ({}));
    }

    const clientTools = {
      // create_lead({ full_name, email, phone, program_interest, language, ... })
      create_lead: async (args) => {
        return postJSON(TOOLS_BASE + "/create_lead", args);
      },
      // schedule_visit({ modality, preferred_dt_local, contact:{ name,email,phone }, program_interest, notes })
      schedule_visit: async (args) => {
        return postJSON(TOOLS_BASE + "/schedule_visit", args);
      }
    };

    // Obtener token efÃ­mero SIEMPRE fresco
    async function getClientSecret(existing) {
      const res = await fetch(SESSION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: deviceId })
      });
      if (!res.ok) throw new Error("No se pudo crear la sesiÃ³n");
      const data = await res.json();
      return data.client_secret; // ek_...
    }

    // Montaje cuando el runtime estÃ© cargado
    function mountWhenReady(){
      if (!window.ChatKit || !window.ChatKit.create) {
        requestAnimationFrame(mountWhenReady);
        return;
      }

      const container = document.getElementById("chat-container");
      let mounted = false;

      const control = window.ChatKit.create({
        api: { getClientSecret },
        tools: clientTools
      });

      document.getElementById("chat-launcher").onclick = () => {
        if (!mounted) {
          window.ChatKit({ control, className: "h-[600px] w-[360px]" }).mount(container);
          mounted = true;
        }
        const show = container.style.display !== "block";
        container.style.display = show ? "block" : "none";
        container.setAttribute("aria-hidden", String(!show));
      };
    }

    // Evita tokens viejos cuando recargas con cachÃ©
    if ("serviceWorker" in navigator) {
      // nada obligatorio; solo recordatorio si usas SW
    }

    mountWhenReady();
  })();
  </script>
</body>
</html>

