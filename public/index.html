<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Isthmus Â· ADN CREATIVO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>
  <meta name="chatkit:domain_public_key" content="domain_pk_68e7da3b8b38819099c41f6a597d5cdf00560b7a3fd09ef4" />

  <style>
    /* VARIABLES DE DISEÃ‘O */
    :root {
      --bg-app: #F5F5F7;        
      --surface: #FFFFFF;       
      --ink: #1D1D1F;           
      --muted: #86868B;         
      --accent: #0071E3;        
      --accent-dark: #000000;   
      
      /* Chat Vars */
      --fab: #1D1D1F; --gap: 20px; --size: 56px; --shadow: 0 12px 30px rgba(0,0,0,.15);

      /* Typography & Physics */
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", "Segoe UI", Roboto, sans-serif;
      --radius-panel: 32px;     
      --radius-btn: 999px;      
      --easing: cubic-bezier(0.25, 1, 0.5, 1);
    }

    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    
    body { 
      margin: 0; 
      font-family: var(--font-stack);
      background: var(--bg-app);
      color: var(--ink);
      line-height: 1.5;
      overflow-x: hidden; 
    }

    /* --- CHATKIT STYLES --- */
    #chat-shell {
      position: fixed; right: 20px; bottom: calc(var(--gap) + var(--size) + 12px);
      width: 360px; height: 600px; display: none;
      background: #fff; border-radius: 24px; overflow: hidden; 
      box-shadow: 0 20px 80px rgba(0,0,0,0.2); z-index: 9998;
      border: 1px solid rgba(0,0,0,0.05);
    }
    #chat-launcher {
      position: fixed; right: var(--gap); bottom: var(--gap);
      width: var(--size); height: var(--size); border-radius: 50%; border: none; cursor: pointer; z-index: 9999;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2); background: var(--fab); color: #fff; font-size: 24px;
      display: inline-flex; align-items: center; justify-content: center; 
      transition: transform 0.4s var(--easing);
    }
    #chat-launcher:hover { transform: scale(1.1); }
    #chat-launcher.hidden { opacity: 0; pointer-events: none; transform: scale(0.5); }
    @media (max-width: 480px){
      #chat-shell{ width: 100vw; height: 100dvh; right: 0; left: 0; bottom: 0; border-radius: 0; }
    }

    /* --- HEADER --- */
    header { 
      padding: 24px 40px; 
      position: absolute; top: 0; left: 0; width: 100%; z-index: 10;
      display: flex; justify-content: space-between; align-items: baseline;
    }
    header h1 { 
      margin: 0; font-size: 16px; letter-spacing: -0.02em; font-weight: 700; text-transform: uppercase; 
    }
    header p { font-size: 14px; color: var(--muted); margin: 0; font-weight: 500;}

    /* --- LAYOUT PRINCIPAL (YQE) --- */
    .yqe {
      min-height: 100vh;
      display: flex; flex-direction: column;
      position: relative;
    }
    .yqe .wrap { 
      width: 100%; max-width: 1000px; margin: 0 auto; 
      padding: 100px 24px 60px; 
      flex: 1; display: flex; flex-direction: column;
    }

    /* --- TYPOGRAPHY BIG (HERO) --- */
    .yqe .hero { 
      text-align: center; margin-bottom: 60px; 
      animation: fadeUp 0.8s var(--easing);
    }
    .yqe .h1 {
      font-size: clamp(3.5rem, 10vw, 7.5rem); 
      line-height: 0.9;
      font-weight: 800;
      letter-spacing: -0.04em; 
      color: var(--ink);
      margin-bottom: 24px;
    }
    .yqe .gradient {
      background: linear-gradient(135deg, #FF3EA5 0%, #7A5CFF 50%, #2EF2A6 100%);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .yqe .lead {
      font-size: clamp(1.1rem, 2vw, 1.5rem);
      line-height: 1.4; color: var(--muted);
      max-width: 580px; margin: 0 auto 40px; font-weight: 500;
    }

    /* --- BOTONES --- */
    .yqe .btn {
      appearance: none; border: none; cursor: pointer;
      font-family: inherit; font-weight: 600; font-size: 17px;
      padding: 18px 36px; border-radius: var(--radius-btn);
      transition: all 0.3s var(--easing);
      display: inline-flex; align-items: center; justify-content: center;
    }
    .yqe .btn-primary {
      background: var(--accent-dark); color: #fff;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .yqe .btn-primary:hover {
      transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .yqe .btn-ghost {
      background: rgba(0,0,0,0.05); color: var(--ink);
      margin-left: 12px;
    }
    .yqe .btn-ghost:hover { background: rgba(0,0,0,0.1); }
    .yqe .cta-row { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }

    /* --- TARJETAS --- */
    .yqe .container { width: 100%; max-width: 680px; margin: 0 auto; position: relative; }
    
    .yqe .card, .yqe .card-white {
      background: var(--surface);
      border-radius: var(--radius-panel);
      padding: 40px;
      box-shadow: 0 20px 60px -10px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.5);
      backdrop-filter: blur(20px);
    }

    /* --- BARRA PROGRESO --- */
    .yqe .progress {
      height: 6px; width: 100%; background: rgba(0,0,0,0.06);
      border-radius: 10px; overflow: hidden; margin-bottom: 40px;
    }
    .yqe .bar {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, #1d1d1f, #4a4a4f);
      transition: width 0.5s var(--easing);
    }
    .yqe #step { 
      text-align: center; font-size: 11px; font-weight: 700; 
      letter-spacing: 0.1em; color: var(--muted); margin-top: 8px; text-transform: uppercase;
    }

    /* --- BENTO GRID --- */
    .yqe .grid { display: grid; gap: 16px; margin-top: 32px; }
    .yqe .grid-4 { grid-template-columns: repeat(4, 1fr); }
    @media(max-width: 600px) { .yqe .grid-4 { grid-template-columns: repeat(2, 1fr); } }

    .yqe .choice {
      background: #F5F5F7; 
      border: 2px solid transparent;
      border-radius: 24px; 
      padding: 20px 10px;
      cursor: pointer;
      transition: all 0.25s var(--easing);
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;
      aspect-ratio: 1 / 0.9;
    }
    .yqe .choice:hover { background: #EBEBF0; transform: scale(1.02); }
    .yqe .choice.sel {
      background: #fff;
      border-color: var(--ink);
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
    }
    .yqe .choice div:first-child { font-size: 32px; line-height: 1; filter: grayscale(1); opacity: 0.7; transition: all .3s; }
    .yqe .choice:hover div:first-child, .yqe .choice.sel div:first-child { filter: grayscale(0); opacity: 1; transform: scale(1.1); }
    .yqe .choice div:last-child { font-weight: 600; font-size: 13px; color: var(--ink); }

    /* --- RESULTADOS --- */
    #qtext {
      font-size: clamp(1.8rem, 3vw, 2.5rem);
      font-weight: 700; letter-spacing: -0.03em; line-height: 1.1;
      margin: 0 0 10px 0; text-align: center;
      min-height: 3em; display: flex; align-items: center; justify-content: center;
    }
    .yqe .pill {
      display: inline-block; padding: 6px 12px;
      background: #F5F5F7; border-radius: 8px;
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted);
      margin-bottom: 12px;
    }
    .yqe .title {
      font-size: clamp(2.5rem, 5vw, 4rem);
      line-height: 1; font-weight: 800; letter-spacing: -0.03em;
      margin: 10px 0 20px;
    }
    .yqe ul.list { list-style: none; padding: 0; }
    .yqe ul.list li {
      padding: 10px 0; border-bottom: 1px solid #F5F5F7;
      font-weight: 500; font-size: 15px; color: var(--ink);
    }
    .yqe .row-gap { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 24px; }
    
    /* --- HOW SECTION --- */
    .yqe .how { display: grid; gap: 20px; margin-top: 60px; }
    @media(min-width: 800px){ .yqe .how { grid-template-columns: repeat(3, 1fr); } }
    .yqe .how .card { padding: 30px; text-align: left; border: none; background: #fff; }
    .yqe .how h3 { margin: 15px 0 5px; font-size: 18px; font-weight: 700; }
    .yqe .how p { margin: 0; font-size: 14px; color: var(--muted); }

    /* --- MODAL --- */
    .yqe .modal {
      position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
      display: none; align-items: center; justify-content: center; padding: 20px; z-index: 50;
    }
    .yqe .modal.show { display: flex; animation: fadeIn 0.3s; }
    .yqe .modal-card {
      background: #fff; color: var(--ink); max-width: 480px; width: 100%;
      border-radius: 32px; padding: 40px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.15); border: 1px solid rgba(0,0,0,0.05);
    }
    .yqe input {
      width: 100%; padding: 16px; border-radius: 12px; border: 2px solid #F5F5F7;
      font-size: 16px; margin-top: 10px; outline: none; transition: border 0.3s;
    }
    .yqe input:focus { border-color: var(--ink); }

    .hidden { display: none !important; }
    .muted { color: var(--muted); }
    .note { font-size: 12px; color: var(--muted); display: block; margin-top: 8px; }
    
    @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- IMPRESIÃ“N CORREGIDA (HIGH CONTRAST) --- */
    @media print {
      body > *, #chat-shell, #chat-launcher, header { display: none !important; }
      body > .yqe { display: block !important; background: white !important; }
      .yqe .wrap { padding: 0 !important; margin: 0 !important; }
      .yqe .container { max-width: 100% !important; margin: 0 !important; }
      .yqe main { padding: 0 !important; }
      .hero, #quiz, #yqe-how, .modal, .note, .cta-row { display: none !important; }

      /* Tarjeta de resultado en papel */
      #result, #result-card {
        display: block !important;
        visibility: visible !important;
        position: static !important;
        background: white !important;
        color: black !important;
        box-shadow: none !important;
        border: 2px solid #000 !important; /* BORDE VISIBLE */
        border-radius: 0 !important;
        width: 100% !important;
        padding: 40px !important;
        margin: 0 !important;
      }
      .yqe .title, .yqe h4, .yqe p, .yqe li, .yqe h2 { color: #000 !important; -webkit-text-fill-color: #000 !important; }
      .yqe .pill { border: 1px solid #000 !important; color: #000 !important; background: transparent !important; }
      .yqe .btn, .yqe details, .yqe summary { display: none !important; }
      #rScores { display: block !important; border-top: 1px dashed #000; margin-top: 20px; padding-top: 10px; }
      #rScores li { font-size: 10px !important; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Isthmus</h1>
    <p>Test ADN Creativo</p>
  </header>

  <section class="yqe" id="yqe-root">
    <div class="wrap">
      
      <section class="hero">
        <div class="h1">Descubre tu <br><span class="gradient">ADN Creativo</span></div>
        <p class="lead">Responde en minutos y descubre tu match profesional. Al final, obtÃ©n tu perfil detallado en PDF.</p>
        <div class="cta-row">
          <button id="btn-start" class="btn btn-primary">Empezar Test</button>
          <button class="btn btn-ghost" onclick="document.getElementById('yqe-how').scrollIntoView({behavior:'smooth'})">Â¿CÃ³mo funciona?</button>
        </div>
      </section>

      <main>
        <div class="container">
          
          <div id="quiz" class="hidden">
            <div style="margin-bottom: 20px;">
              <div class="progress"><div id="bar" class="bar"></div></div>
              <div id="step">1/12</div>
            </div>

            <div id="card" class="card">
              <div class="pill" style="display:block; text-align:center;">Pregunta</div>
              <h2 id="qtext">...</h2>
              <div class="grid grid-4">
                <button class="choice" data-value="0"><div>ğŸ˜¶â€ğŸŒ«ï¸</div><div>Nada</div></button>
                <button class="choice" data-value="1"><div>ğŸ™‚</div><div>Poco</div></button>
                <button class="choice" data-value="2"><div>ğŸ”¥</div><div>Bastante</div></button>
                <button class="choice" data-value="3"><div>ğŸš€</div><div>Mucho</div></button>
              </div>
              <div class="row-gap" style="justify-content: space-between; margin-top: 40px;">
                <button id="prev" class="btn btn-ghost" style="font-size:14px;" disabled>AtrÃ¡s</button>
                <button id="next" class="btn btn-primary" style="padding: 14px 28px;">Siguiente</button>
              </div>
            </div>
            <div class="muted" style="text-align:center; margin-top:20px; font-size:13px;">No es un examen, sigue tu instinto visual.</div>
          </div>

          <section id="yqe-how" class="how">
            <div class="card">
              <div style="font-size:32px; margin-bottom:12px;">âš¡</div>
              <h3>RÃ¡pido y visual</h3><p>Solo 12 preguntas (y 2 extra si hay empate). Terminas en 3â€“5 min.</p>
            </div>
            <div class="card">
              <div style="font-size:32px; margin-bottom:12px;">ğŸ§ </div>
              <h3>Habilidades reales</h3><p>Soft + hard skills que verÃ¡s en clase: ARQ, Interior, Industrial y ComunicaciÃ³n.</p>
            </div>
            <div class="card">
              <div style="font-size:32px; margin-bottom:12px;">ğŸ¯</div>
              <h3>Resultado Ãºtil</h3><p>Tu carrera sugerida, un mini-reto semanal y un PDF para compartir.</p>
            </div>
          </section>

          <section id="result" class="hidden" style="margin-top:24px">
            <div id="result-card" class="card-white">
              <div class="pill">Tu afinidad creativa</div>
              <div id="rTitle" class="title">â€”</div>
              <p id="rNarrative" style="font-size:18px; margin:8px 0 32px; color:var(--muted); line-height:1.6;"></p>
              
              <div class="row-gap" style="align-items:flex-start;">
                <div style="flex:1; min-width:260px;">
                  <h4 style="margin:0 0 10px; font-size:12px; text-transform:uppercase; letter-spacing:0.1em;">Tus Soft Skills</h4>
                  <ul id="rSoft" class="list"></ul>
                </div>
                <div style="flex:1; min-width:260px;">
                  <h4 style="margin:0 0 10px; font-size:12px; text-transform:uppercase; letter-spacing:0.1em;">Tus Hard Skills</h4>
                  <ul id="rHard" class="list"></ul>
                </div>
              </div>

              <div style="margin-top:32px; background:#F5F5F7; border-radius:20px; padding:24px;">
                <div class="pill" style="background:#fff;">Mini-reto semanal</div>
                <p id="rChallenge" style="margin:10px 0 0; font-weight:600; font-size:16px;"></p>
              </div>

              <div class="row-gap" style="margin-top:32px; border-top:1px solid #F5F5F7; padding-top:24px;">
                <button id="btnPDF" class="btn" style="background:#1d1d1f; color:#fff;">Descargar PDF</button>
              </div>
              <div class="row-gap" style="margin-top:16px">
                <button class="btn btn-primary" id="ctaChatResult" style="width:100%; background:var(--accent);">Hablar con un asesor ahora</button>
                <span class="note" style="width:100%; text-align:center;">El chat estÃ¡ abajo a la derecha â†˜ï¸</span>
              </div>
              <details style="margin-top:24px; cursor:pointer;">
                <summary style="font-size:13px; color:var(--muted);">Ver desglose de puntajes</summary>
                <ul id="rScores" style="margin:10px 0; font-size:13px; color:var(--muted); list-style:none; padding:0;"></ul>
              </details>
            </div>
          </section>

          <div id="leadModal" class="modal">
            <div class="modal-card">
              <h3 style="margin:0 0 10px; font-size:28px; font-weight:800;">Tu perfil estÃ¡ listo</h3>
              <p style="margin:0 0 20px; color:var(--muted);">Ingresa tu correo para generar y descargar tu PDF personalizado.</p>
              <form id="leadForm">
                <label for="leadEmail" style="font-weight:700; font-size:12px; text-transform:uppercase;">Correo electrÃ³nico</label>
                <input id="leadEmail" type="email" required placeholder="nombre@ejemplo.com">
                <small class="note">Te enviaremos una copia. No spam.</small>
                <div class="row-gap" style="margin-top:24px">
                  <button type="submit" class="btn btn-primary" style="flex:1;">Descargar</button>
                  <button type="button" id="leadCancel" class="btn btn-ghost" style="flex:0;">Cancelar</button>
                </div>
              </form>
            </div>
          </div>

          <p class="note" style="text-align:center; margin-top:60px;">Isthmus Zero-Backend. Â© <span id="year">2025</span></p>
        </div>
      </main>
    </div>
  </section>

  <div id="chat-shell" role="dialog" aria-modal="true">
    <openai-chatkit id="isthmus-chat" class="h-[600px] w-[360px]"></openai-chatkit>
  </div>
  <button id="chat-launcher" aria-label="Abrir chat" aria-controls="chat-shell" aria-expanded="false">ğŸ’¬</button>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $ = (id) => document.getElementById(id);
    const setText = (id, txt) => { const el = $(id); if (el) el.textContent = txt; };
    setText('year', String(new Date().getFullYear()));

    const itemsCore = [
      { id:1,  text:'Puedo imaginar cÃ³mo cambiarÃ­a un lugar con luz y materiales.', weights:{INT:1, ARQ:0.5} },
      { id:2,  text:'Me interesa cÃ³mo se planean ciudades/edificios y sus reglas.', weights:{ARQ:1} },
      { id:3,  text:'Disfruto convertir ideas en objetos usables.', weights:{IND:1, ARQ:0.5} },
      { id:4,  text:'Me sale natural contar ideas con imÃ¡genes, colores y tipografÃ­as.', weights:{COM:1} },
      { id:5,  text:'Me fijo en detalles que cambian la atmÃ³sfera (texturas, sonido, luz).', weights:{INT:1, COM:0.5} },
      { id:6,  text:'Me intriga cÃ³mo estÃ¡n hechas las cosas y cÃ³mo mejorarlas tÃ©cnicamente.', weights:{IND:1} },
      { id:7,  text:'Pienso en sistemas y relaciÃ³n entre partes y todo.', weights:{ARQ:1, IND:0.5} },
      { id:8,  text:'Me emociona diseÃ±ar experiencias visuales que cuenten historias.', weights:{COM:1, INT:0.5} },
      { id:9,  text:'Prefiero prototipar/maquetar a solo hablar de ideas.', weights:{IND:1, ARQ:0.5} },
      { id:10, text:'Me interesa la luz (natural/artificial) y su efecto en la vida del espacio.', weights:{INT:1, ARQ:0.5} },
      { id:11, text:'Disfruto preparar presentaciones visuales claras y persuasivas.', weights:{COM:1, ARQ:0.5} },
      { id:12, text:'Me motivan retos reales con restricciones y usuarios concretos.', weights:{ARQ:0.5, INT:0.5, IND:0.5, COM:0.5} }
    ];

    const tiebreakers = [
      { id:13, pair:['ARQ','INT'], text:'Me interesa mÃ¡s la estructura y funciÃ³n del edificio que la atmÃ³sfera interior.', yes:'ARQ', no:'INT' },
      { id:14, pair:['IND','COM'], text:'Prefiero funciÃ³n y fabricaciÃ³n antes que mensaje e identidad.', yes:'IND', no:'COM' },
      { id:15, pair:['ARQ','IND'], text:'Me veo liderando proyectos a gran escala mÃ¡s que perfeccionando un objeto.', yes:'ARQ', no:'IND' },
      { id:16, pair:['INT','COM'], text:'Me mueve mÃ¡s la sensaciÃ³n del lugar que la comunicaciÃ³n visual.', yes:'INT', no:'COM' }
    ];

    const RESULT_TEXT = {
      ARQ: { title:'Arquitectura', narrative:'Piensas en sistemas, escalas y orden. Te motiva transformar ciudad y edificio con visiÃ³n y mÃ©todo.', soft:['Pensamiento sistÃ©mico','VisualizaciÃ³n espacial','Liderazgo de proyectos'], hard:['Dibujo tÃ©cnico','Modelado 3D','PlaneaciÃ³n urbana'], challenge:'Dibuja un mapa de flujo de tu barrio y propone una mejora.' },
      INT: { title:'Arquitectura Interior', narrative:'Lees la atmÃ³sfera: luz, materiales y experiencia humana. Haces que los lugares se sientan bien.', soft:['EmpatÃ­a','Sensibilidad estÃ©tica','AtenciÃ³n al detalle'], hard:['IluminaciÃ³n','Materialidad y acabados','RepresentaciÃ³n visual'], challenge:'DiseÃ±a 2 escenas de luz (dÃ­a/noche) para una habitaciÃ³n.' },
      IND: { title:'DiseÃ±o Industrial', narrative:'Del concepto al objeto. Mejoras cÃ³mo funcionan las cosas con tÃ©cnica, prototipo y curiosidad.', soft:['Pensamiento funcional','Curiosidad tÃ©cnica','ResoluciÃ³n de problemas'], hard:['Prototipado','Procesos de manufactura','Modelado paramÃ©trico'], challenge:'RediseÃ±a un objeto cotidiano para que sea mÃ¡s fÃ¡cil de reparar.' },
      COM: { title:'ComunicaciÃ³n Visual', narrative:'Conectas ideas y emociones con imÃ¡genes, tipografÃ­a y narrativa. Das forma a mensajes que viven.', soft:['Pensamiento simbÃ³lico','Creatividad narrativa','ObservaciÃ³n cultural'], hard:['TipografÃ­a','IlustraciÃ³n/DirecciÃ³n de arte','Branding digital'], challenge:'Crea un afiche para una causa usando 2 tipografÃ­as y 2 colores.' }
    };

    let idx = 0, flow = itemsCore.slice();
    const answers = {}; let scores = {ARQ:0, INT:0, IND:0, COM:0};

    const quiz = $('quiz'); const how = $('yqe-how'); const btnStart = $('btn-start');
    const bar = $('bar'); const step = $('step'); const qtext = $('qtext');
    const prev = $('prev'); const next = $('next'); const card = $('card');
    const resultSec = $('result'); const rTitle = $('rTitle'); const rNarrative = $('rNarrative');
    const rSoft = $('rSoft'); const rHard = $('rHard'); const rChallenge = $('rChallenge');
    const rScores = $('rScores'); const btnPDF = $('btnPDF');
    const leadModal = $('leadModal'); const leadForm = $('leadForm'); const leadEmail = $('leadEmail'); const leadCancel = $('leadCancel');

    if (!btnStart || !quiz || !qtext || !prev || !next) { console.error('Error DOM'); return; }

    btnStart.addEventListener('click', () => {
      idx = 0; flow = itemsCore.slice();
      for (const k of Object.keys(answers)) delete answers[k];
      scores = {ARQ:0, INT:0, IND:0, COM:0};
      quiz.classList.remove('hidden'); 
      if (how) how.style.display = 'none'; 
      $('yqe-root').scrollIntoView({behavior:'smooth'}); 
      render();
    });

    const choices = Array.from(document.querySelectorAll('.yqe .choice'));
    choices.forEach(btn => btn.addEventListener('click', (e)=>{
      const v = Number(e.currentTarget.getAttribute('data-value'));
      const id = flow[idx].id; answers[id] = v;
      choices.forEach(c => c.classList.remove('sel')); e.currentTarget.classList.add('sel');
    }));

    next.addEventListener('click', ()=>{
      if (answers[flow[idx].id] == null) { if(card){ card.style.animation='shake .35s linear 1'; setTimeout(()=> card.style.animation='', 360);} return; }
      if (idx < flow.length-1) { idx++; render(); } else { finish(); }
    });
    prev.addEventListener('click', ()=>{ if(idx>0){ idx--; render(); } });

    function render(){
      const it = flow[idx]; if(!it){ finish(); return; }
      if (qtext) qtext.textContent = it.text;
      if (step) step.textContent = (idx+1)+'/'+flow.length;
      if (bar) bar.style.width = (idx/flow.length*100)+'%';
      if (prev) prev.disabled = idx===0;
      if (next) next.textContent = idx===flow.length-1 ? 'Ver resultado' : 'Siguiente';

      choices.forEach(btn => btn.classList.remove('sel'));
      const saved = answers[it.id];
      if(saved!=null){
        const btn = choices.find(b => Number(b.getAttribute('data-value'))===saved);
        if(btn) btn.classList.add('sel');
      } else if (it.binary){
        choices[0].lastElementChild.textContent = 'No'; choices[0].firstElementChild.textContent = 'ğŸ™…'; choices[0].setAttribute('data-value','0');
        choices[1].lastElementChild.textContent = 'SÃ­'; choices[1].firstElementChild.textContent = 'âœ…'; choices[1].setAttribute('data-value','3');
        choices[2].style.display='none'; choices[3].style.display='none';
        choices[0].parentElement.classList.replace('grid-4','grid-2');
        choices[0].parentElement.style.gridTemplateColumns = '1fr 1fr';
      } else {
        const labels = ['Nada','Poco','Bastante','Mucho']; const emojis = ['ğŸ˜¶â€ğŸŒ«ï¸','ğŸ™‚','ğŸ”¥','ğŸš€'];
        choices[0].parentElement.classList.replace('grid-2','grid-4');
        choices[0].parentElement.style.gridTemplateColumns = '';
        for(let i=0;i<4;i++){ choices[i].style.display='flex'; choices[i].lastElementChild.textContent = labels[i]; choices[i].firstElementChild.textContent = emojis[i]; choices[i].setAttribute('data-value', String(i)); }
      }
    }

    function scoreAll(){
      scores = {ARQ:0, INT:0, IND:0, COM:0};
      for(const it of flow){
        const v = answers[it.id] ?? 0;
        for(const k in it.weights){ scores[k] += v * it.weights[k]; }
      }
      return scores;
    }

    function maybeAppendTiebreaker(){
      const s = scoreAll(); const arr = Object.entries(s).sort((a,b)=> b[1]-a[1]);
      const diff = arr[0][1]-arr[1][1]; if (diff>=2) return false;
      for(const tb of tiebreakers){
        const set = new Set(tb.pair);
        if(set.has(arr[0][0]) && set.has(arr[1][0]) && !flow.find(i=> i.id===tb.id)){
          flow.push({ id:tb.id, text: tb.text + ' (SÃ­/No)', weights: {[tb.yes]:1}, binary:true }); return true;
        }
      }
      return false;
    }

    function finish(){
      if (maybeAppendTiebreaker()){ render(); return; }
      scoreAll();
      const sorted = Object.entries(scores).sort((a,b)=> b[1]-a[1]);
      const key = sorted[0][0]; const data = RESULT_TEXT[key];
      if (!data) return;

      quiz.classList.add('hidden'); 
      if (resultSec) resultSec.classList.remove('hidden'); resultSec?.scrollIntoView({behavior:'smooth'});
      $('rTitle').textContent = data.title; $('rNarrative').textContent = data.narrative;
      $('rSoft').innerHTML = data.soft.map(x=>'<li>'+x+'</li>').join('');
      $('rHard').innerHTML = data.hard.map(x=>'<li>'+x+'</li>').join('');
      $('rChallenge').textContent = data.challenge;
      $('rScores').innerHTML = sorted.map(([k,v])=>'<li><b>'+RESULT_TEXT[k].title+':</b> '+v.toFixed(1)+'</li>').join('');
    }

    const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xanpllkz';
    function sendLead(email, resultKey, scores){
      const payload = { email, result: resultKey, scores: JSON.stringify(scores) };
      return fetch(FORMSPREE_ENDPOINT, {
        method: 'POST', headers: { 'Accept': 'application/json', 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      }).catch(e => console.warn('Error Formspree:', e));
    }

    if ($('btnPDF')) $('btnPDF').addEventListener('click', ()=> { $('leadModal')?.classList.add('show'); $('leadEmail')?.focus(); });
    if ($('leadCancel')) $('leadCancel').addEventListener('click', ()=> $('leadModal')?.classList.remove('show'));
    if ($('leadForm')) $('leadForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('leadEmail')?.value?.trim();
      if(!email){ $('leadEmail')?.reportValidity(); return; }
      const sorted = Object.entries(scores).sort((a,b)=> b[1]-a[1]);
      const topKey = sorted[0][0];
      await sendLead(email, topKey, scores);
      $('leadModal')?.classList.remove('show');
      window.print();
    });

    const btnAsesor = document.getElementById('ctaChatResult');
    btnAsesor?.addEventListener('click', () => { document.getElementById('chat-launcher')?.click(); });
  });
  </script>

  <script>
  (function(){
    const SESSION_URL = "/api/chatkit/session";
    const TOOLS_BASE  = "/tools";
    const shell  = document.getElementById("chat-shell");
    const comp   = document.getElementById("isthmus-chat");
    const key = "ck_device_id";
    let deviceId = localStorage.getItem(key);
    if (!deviceId) { deviceId = (self.crypto?.randomUUID && crypto.randomUUID()) || String(Date.now()); localStorage.setItem(key, deviceId); }
    async function postJSON(url, payload){ const r = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) }); let data = {}; try { data = await r.json(); } catch {} if (!r.ok) return Object.assign({ ok:false }, data, { status:r.status }); return Object.assign({ ok:true }, data); }
    async function getClientSecret(current){ const r = await fetch(SESSION_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ userId: deviceId, currentClientSecret: current || null }) }); if (!r.ok) throw new Error("session "+r.status); const j = await r.json(); return j.client_secret; }
    async function autoCreateLeadFromVisit(clean, noteExtra){ const lang = (navigator.language || "es").toLowerCase().startsWith("es") ? "es" : "en"; const payload = { full_name: clean?.contact?.name || "Sin nombre", email: clean?.contact?.email || "", phone: clean?.contact?.phone || "", program_interest: clean?.program_interest || "no_especificado", language: lang, source_channel: "web", consent_personal_data: "yes", privacy_ack: "yes", costs_email_requested: "no", notes: `Lead auto-creado por cita. ${noteExtra||""}`.trim() }; await postJSON(TOOLS_BASE + "/create_lead", payload); return true; }
    async function onClientTool({ name, params }) { const { tool, ...clean } = params || {}; if (name === "create_lead") { if (!clean.email) return "error:missing_email"; const resp = await postJSON(TOOLS_BASE + "/create_lead", clean); return resp.ok ? "create_lead: ok" : "error:lead_failed"; } if (name === "schedule_visit") { if (!clean.contact?.email) return "error:missing_contact"; const resp = await postJSON(TOOLS_BASE + "/schedule_visit", clean); if (resp.ok) { await autoCreateLeadFromVisit(clean); return "schedule_visit: ok"; } return "error:visit_failed"; } return "error:tool_not_implemented"; }
    async function ensureReady(){ if (!customElements.get("openai-chatkit")) await customElements.whenDefined("openai-chatkit"); comp.setOptions({ api: { getClientSecret }, onClientTool, locale: "es", composer: { placeholder: "PregÃºntame por programas..." }, startScreen: { greeting: "Â¡Hola! Soy el asesor de ISTHMUS.", prompts: [ { label: "Conocer programas", prompt: "Info programas", icon: "search" }, { label: "Agendar visita", prompt: "Quiero agendar visita", icon: "calendar" } ] } }); }
    function showShell(show){ shell.style.display = show ? "block" : "none"; document.getElementById('chat-launcher').classList.toggle("hidden", show); }
    let configured = false;
    document.getElementById('chat-launcher').addEventListener("click", async () => { try { if (shell.style.display === "block") { showShell(false); return; } if (!configured) { await ensureReady(); configured = true; } showShell(true); } catch (e) { console.error(e); } });
  })();
  </script>
</body>
</html>
