<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Isthmus ¬∑ Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- ChatKit runtime -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>
  <!-- Verificaci√≥n de dominio -->
  <meta name="chatkit:domain_public_key" content="domain_pk_68e7da3b8b38819099c41f6a597d5cdf00560b7a3fd09ef4" />

  <style>
    :root{ --fab:#0b5d3f; --shadow:0 12px 30px rgba(0,0,0,.25); --gap:20px; --size:56px; }
    *{ box-sizing:border-box } body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:#f6f8fb; }
    header{ padding:20px; border-bottom:1px solid #eef2f6 } main{ padding:20px }

    #chat-shell{
      position:fixed; right:20px; bottom:calc(var(--gap) + var(--size) + 12px);
      width:360px; height:600px; background:#fff; border-radius:12px; overflow:auto;
      box-shadow:var(--shadow); display:none; z-index:9998; padding:0;
    }
    #chat-launcher{
      position:fixed; right:var(--gap); bottom:var(--gap);
      width:var(--size); height:var(--size); border:none; border-radius:50%;
      background:var(--fab); color:#fff; font-size:22px; cursor:pointer; z-index:9999;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      display:inline-flex; align-items:center; justify-content:center;
      transition:opacity .25s, transform .25s;
    }
    #chat-launcher.hidden{ opacity:0; transform:translateY(10px); pointer-events:none }

    /* Fallback Lite */
    .lite{ padding:16px }
    .lite h3{ margin:8px 0 12px }
    .lite form{ display:grid; gap:8px; margin:12px 0 18px }
    .lite input, .lite select, .lite textarea{
      width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:10px; font:inherit;
    }
    .lite button{
      background:#0b5d3f; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    .hint{ font-size:12px; color:#64748b }
    .ok{ color:#0b5d3f } .err{ color:#b91c1c }

    @media (max-width:480px){
      #chat-shell{ right:0; left:0; bottom:0; width:100vw; height:70vh; border-radius:12px 12px 0 0; }
      #chat-launcher{ bottom:28px }
    }
  </style>
</head>
<body>
  <header>
    <h1>Demo Isthmus</h1>
    <p>Abre el chat abajo a la derecha.</p>
  </header>
  <main><p>Contenido de ejemplo‚Ä¶</p></main>

  <div id="chat-shell" role="dialog" aria-modal="true"></div>
  <button id="chat-launcher" aria-label="Abrir chat">üí¨</button>

  <script>
  (function(){
    const SESSION_URL = "/api/chatkit/session";
    const TOOLS_BASE  = "/tools";

    const shell = document.getElementById("chat-shell");
    const fab   = document.getElementById("chat-launcher");
    const MOBILE = matchMedia("(max-width:480px)").matches;

    // ID estable
    const deviceIdKey = "ck_device_id";
    let deviceId = localStorage.getItem(deviceIdKey);
    if (!deviceId) { deviceId = (crypto?.randomUUID?.()||String(Date.now())); localStorage.setItem(deviceIdKey, deviceId); }

    // Helpers
    async function postJSON(url, payload){
      const r = await fetch(url,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      let data={}; try{ data = await r.json(); }catch{}
      if(!r.ok) throw new Error((data && (data.error||data.status)) || ("HTTP "+r.status));
      return data;
    }
    async function getClientSecret(current){
      const r = await fetch(SESSION_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ userId: deviceId, currentClientSecret: current||null }) });
      if(!r.ok){ throw new Error("session "+r.status); }
      const j = await r.json(); return j.client_secret;
    }
    async function sentinelReachable(timeoutMs=1200){
      try{ const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
        await fetch("https://sentinel.openai.com/req", { mode:"no-cors", signal: ctrl.signal }); clearTimeout(t); return true;
      }catch{ return false; }
    }

    function showShell(show){
      shell.style.display = show ? "block" : "none";
      fab.classList.toggle("hidden", show);
    }

    // --- Fallback Lite UI ---
    function mountLite(){
      shell.innerHTML = `
        <div class="lite">
          <h3>Asesor virtual ‚Äî modo simple</h3>
          <p class="hint">Tu red est√° bloqueando el chat interactivo. Puedes dejarnos tus datos y coordinamos por correo/tel√©fono.</p>

          <section>
            <h4>Enviar <b>costos por correo</b></h4>
            <form id="f-lead">
              <input name="full_name" placeholder="Nombre completo" required />
              <input type="email" name="email" placeholder="Email" required />
              <input name="phone" placeholder="Tel√©fono" required />
              <select name="program_interest" required>
                <option value="">Programa de inter√©s</option>
                <option>Arquitectura</option>
                <option>Arquitectura Interior</option>
                <option>Dise√±o Industrial</option>
                <option>Dise√±o y Comunicaci√≥n</option>
              </select>
              <textarea name="notes" placeholder="Notas (opcional)"></textarea>
              <input type="hidden" name="language" value="es"/>
              <input type="hidden" name="source_channel" value="web"/>
              <input type="hidden" name="consent_personal_data" value="yes"/>
              <input type="hidden" name="privacy_ack" value="yes"/>
              <input type="hidden" name="costs_email_requested" value="yes"/>
              <button type="submit">Solicitar costos</button>
              <div id="m-lead" class="hint"></div>
            </form>
          </section>

          <section>
            <h4><b>Agendar</b> visita/llamada</h4>
            <form id="f-cita">
              <select name="modality" required>
                <option value="">Modalidad</option>
                <option value="presencial">Presencial</option>
                <option value="virtual">Virtual</option>
              </select>
              <input name="preferred_dt_local" placeholder="Fecha y hora (ej. 2025-10-16T11:00:00-05:00)" required />
              <input name="name" placeholder="Tu nombre" required />
              <input type="email" name="email" placeholder="Email" required />
              <input name="phone" placeholder="Tel√©fono" required />
              <input name="program_interest" placeholder="Programa (opcional)" />
              <textarea name="notes" placeholder="Notas (opcional)"></textarea>
              <button type="submit">Registrar solicitud</button>
              <div id="m-cita" class="hint"></div>
            </form>
          </section>
        </div>
      `;

      // Handlers
      const lead = shell.querySelector("#f-lead");
      const mLead = shell.querySelector("#m-lead");
      lead.onsubmit = async (e)=>{
        e.preventDefault();
        const p = Object.fromEntries(new FormData(lead).entries());
        mLead.textContent = "Enviando‚Ä¶";
        try { await postJSON(TOOLS_BASE+"/create_lead", p);
          mLead.innerHTML = '<span class="ok">Listo. Te enviamos los costos por correo a la brevedad.</span>';
          lead.reset();
        } catch(err){
          mLead.innerHTML = '<span class="err">No se pudo registrar. Intenta m√°s tarde.</span>';
        }
      };

      const cita = shell.querySelector("#f-cita");
      const mCita = shell.querySelector("#m-cita");
      cita.onsubmit = async (e)=>{
        e.preventDefault();
        const fd = new FormData(cita);
        const payload = {
          modality: fd.get("modality"),
          preferred_dt_local: fd.get("preferred_dt_local"),
          contact: { name: fd.get("name"), email: fd.get("email"), phone: fd.get("phone") },
          program_interest: fd.get("program_interest") || "",
          notes: fd.get("notes") || ""
        };
        mCita.textContent = "Registrando‚Ä¶";
        try { const r = await postJSON(TOOLS_BASE+"/schedule_visit", payload);
          mCita.innerHTML = '<span class="ok">Solicitud registrada. Te confirmaremos por correo/tel√©fono.</span>';
          cita.reset();
        } catch(err){
          mCita.innerHTML = '<span class="err">No se pudo registrar. Nuestro equipo te contactar√° (registro manual creado).</span>';
        }
      };
    }

    // --- ChatKit normal ---
    let mounted = false, chatEl = null;
    async function mountChat(){
      if (mounted) return;
      // Espera a que el custom element exista
      if (!customElements.get("openai-chatkit")) {
        await customElements.whenDefined("openai-chatkit");
      }
      chatEl = document.createElement("openai-chatkit");
      chatEl.className = "h-[600px] w-[360px]";
      shell.replaceChildren(chatEl);

      chatEl.setOptions({
        api: { getClientSecret },
        locale: "es",
        composer: { placeholder: "Preg√∫ntame por programas, requisitos o agenda una visita‚Ä¶" },
        startScreen: {
          greeting: "¬°Hola! Soy el asesor virtual de Admisiones de ISTHMUS. ¬øC√≥mo te llamas?",
          prompts: [
            { label:"Conocer Arquitectura", prompt:"Quiero informaci√≥n del programa de Arquitectura.", icon:"search" },
            { label:"Costos por correo",    prompt:"Env√≠enme los costos por correo, por favor.",       icon:"write"  },
            { label:"Agendar visita",       prompt:"Quiero agendar una visita al campus.",            icon:"calendar" }
          ]
        },
        async onClientTool({ name, params }) {
          if (name === "create_lead")    return await postJSON(TOOLS_BASE+"/create_lead", params);
          if (name === "schedule_visit") return await postJSON(TOOLS_BASE+"/schedule_visit", params);
          throw new Error("client tool no reconocida: "+name);
        },
        theme: { colorScheme:"light", color:{ accent:{ primary:"#0b5d3f", level:2 } }, radius:"round", density:"normal" }
      });
      mounted = true;
    }

    async function openPanel(){
      fab.classList.add("hidden");
      showShell(true);

      // En m√≥vil, esconder FAB a los 5s cuando el panel est√° cerrado; abierto ya est√° oculto
      if (!mounted) {
        const ok = await sentinelReachable();
        if (!ok) { mountLite(); return; }
        try { await mountChat(); }
        catch(e){ console.warn("Fallo montando ChatKit, usando Lite:", e); mountLite(); }
      }
    }
    function closePanel(){ showShell(false); if (MOBILE) setTimeout(()=>fab.classList.add("hidden"), 5000); }

    fab.addEventListener("click", ()=>{
      const open = shell.style.display === "block";
      open ? closePanel() : openPanel();
    });

    // Auto-ocultar FAB en m√≥vil a los 5s (cuando el panel est√° cerrado)
    if (MOBILE) setTimeout(()=>fab.classList.add("hidden"), 5000);
  })();
  </script>
</body>
</html>





