<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Isthmus · Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- ChatKit runtime -->
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>

    <!-- Verificación de dominio -->
    <meta name="chatkit:domain_public_key" content="domain_pk_68e7da3b8b38819099c41f6a597d5cdf00560b7a3fd09ef4" />

    <style>
      :root{
        --fab:#0b6b3a; /* verde oscuro */
        --shadow: 0 12px 30px rgba(0,0,0,.25);
      }
      *{box-sizing:border-box}
      body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:#f6f8fb; }

      /* Contenedor del chat (lo montamos dentro) */
      #chat-container{
        position: fixed; right: 20px; bottom: 88px; width: 360px; height: 600px;
        background:#fff; border-radius:12px; overflow:hidden; box-shadow: var(--shadow);
        display:none; z-index: 9998;
      }

      /* Botón flotante */
      #chat-launcher{
        position: fixed; right: 16px; bottom: calc(16px + env(safe-area-inset-bottom, 0px));
        width:56px; height:56px; border:none; border-radius:50%;
        background:var(--fab); color:#fff; font-size:22px; cursor:pointer; z-index:9999;
        box-shadow: 0 6px 20px rgba(0,0,0,.2);
        transition: opacity .18s ease, transform .18s ease, visibility .18s ease;
      }

      /* Cerrar superpuesto */
      #chat-close{
        position:absolute; top:8px; right:8px; width:36px; height:36px;
        border:none; border-radius:9999px; background:rgba(0,0,0,.55); color:#fff;
        font-size:20px; line-height:36px; text-align:center; cursor:pointer; z-index:10000; display:none;
      }
      .open #chat-close{ display:block; }

      /* Móvil */
      @media (max-width:480px){
        #chat-container{ width:100vw; height:70vh; right:0; left:0; bottom:0; border-radius:0; }
      }
    </style>
  </head>
  <body>
    <div id="chat-container" role="dialog" aria-modal="true">
      <button id="chat-close" aria-label="Cerrar chat" title="Cerrar">×</button>
      <!-- aquí se montará ChatKit -->
    </div>
    <button id="chat-launcher" aria-controls="chat-container" aria-expanded="false" aria-label="Abrir chat" title="Abrir chat">💬</button>

    <script>
      // Endpoints (mismo Railway)
      const SESSION_URL = "/api/chatkit/session";
      const TOOLS_BASE  = "/tools";

      // DOM
      const container = document.getElementById("chat-container");
      const launcher  = document.getElementById("chat-launcher");
      const closer    = document.getElementById("chat-close");
      const MOBILE_Q  = window.matchMedia("(max-width: 480px)");

      // ID estable
      const deviceIdKey = "ck_device_id";
      let deviceId = localStorage.getItem(deviceIdKey);
      if (!deviceId) {
        deviceId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
        localStorage.setItem(deviceIdKey, deviceId);
      }

      // Helpers
      async function postJSON(url, payload){
        try{
          const r = await fetch(url,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
          const data = await r.json().catch(()=> ({}));
          if(!r.ok) return { ok:false, http_status:r.status, ...data };
          return data;
        }catch{
          return { ok:false, error:"client_fetch_error" };
        }
      }
      async function getClientSecret(){
        const res = await fetch(SESSION_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ userId: deviceId })
        });
        if(!res.ok) throw new Error("No se pudo crear la sesión");
        const { client_secret } = await res.json();
        return client_secret;
      }

      // Nuevo API: onClientTool
      async function onClientTool({ name, params }) {
        switch (name) {
          case "create_lead":    return await postJSON(TOOLS_BASE + "/create_lead", params);
          case "schedule_visit": return await postJSON(TOOLS_BASE + "/schedule_visit", params);
          default: throw new Error(`Herramienta no implementada en cliente: ${name}`);
        }
      }

      // Ocultar/mostrar FAB
      function hideFab(){ launcher.style.opacity="0"; launcher.style.visibility="hidden"; launcher.style.pointerEvents="none"; launcher.style.transform="scale(.92)"; }
      function showFab(){ launcher.style.opacity=""; launcher.style.visibility=""; launcher.style.pointerEvents=""; launcher.style.transform=""; }
      let hideTimer = null;

      // Montaje imperativo robusto
      let mounted = false;
      let control = null;

      function mountWhenReady(){
        if (!window.ChatKit || !window.ChatKit.create) {
          requestAnimationFrame(mountWhenReady);
          return;
        }
        control = window.ChatKit.create({
          api: { getClientSecret },
          onClientTool,
          locale: "es",
          composer: { placeholder: "Pregúntame por programas, requisitos o agenda una visita…" },
          startScreen: {
            greeting: "¡Hola! Soy el asesor virtual de Admisiones de ISTHMUS. ¿Cómo te llamas?",
            prompts: [
              { label:"Conocer Arquitectura", prompt:"Quiero información del programa de Arquitectura.", icon:"search" },
              { label:"Costos por correo",    prompt:"Envíenme los costos por correo, por favor.",       icon:"write"  },
              { label:"Agendar visita",       prompt:"Quiero agendar una visita al campus.",            icon:"calendar"}
            ]
          },
          theme: {
            color: { accent: { primary: "#0b6b3a" } }, // sin propiedades “raras”
            radius: "round",
            density: "normal"
          }
        });

        mounted = true;
      }

      function openChat(){
        if (!mounted) mountWhenReady();
        // Monta el widget dentro del contenedor
        window.ChatKit({ control, className: "h-[600px] w-[360px]" }).mount(container);
        container.style.display = "block";
        container.classList.add("open");
        launcher.setAttribute("aria-expanded","true");

        // móvil: ocultar FAB a los 5s
        showFab();
        if (hideTimer) clearTimeout(hideTimer);
        if (MOBILE_Q.matches) hideTimer = setTimeout(hideFab, 5000);
        // foco al botón cerrar
        setTimeout(() => closer.focus({ preventScroll:true }), 0);
      }

      function closeChat(){
        // devuelve foco al FAB
        launcher.focus({ preventScroll:true });
        // sólo ocultamos el contenedor; ChatKit maneja su ciclo internamente
        container.style.display = "none";
        container.classList.remove("open");
        launcher.setAttribute("aria-expanded","false");
        if (hideTimer) clearTimeout(hideTimer);
        showFab();
      }

      launcher.addEventListener("click", () => {
        const isOpen = container.style.display === "block";
        if (isOpen) closeChat(); else openChat();
      });
      closer.addEventListener("click", closeChat);

      // Reaplica en cambios de tamaño/orientación (Android + teclado)
      ["resize","orientationchange"].forEach(ev =>
        window.addEventListener(ev, () => {
          const open = container.style.display === "block";
          if (open) { showFab(); if (MOBILE_Q.matches){ if (hideTimer) clearTimeout(hideTimer); hideTimer = setTimeout(hideFab, 5000); } }
          else showFab();
        })
      );

      // Seguridad: captura errores para que no “se ponga blanco”
      window.addEventListener("error", (e) => {
        console.error("Chat error:", e.message);
      });
      window.addEventListener("unhandledrejection", (e) => {
        console.error("Chat promise error:", e.reason);
      });
    </script>
  </body>
</html>



