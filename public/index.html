<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Isthmus · ChatAgent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- ChatKit runtime -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>

  <!-- Verificación de dominio (domain_pk) -->
  <meta name="chatkit:domain_public_key" content="domain_pk_68e7da3b8b38819099c41f6a597d5cdf00560b7a3fd09ef4" />

  <style>
    :root{ --fab:#0b5d3f; --gap:20px; --size:56px; --shadow:0 12px 30px rgba(0,0,0,.25); }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:#f6f8fb; }

    #chat-shell{
      position: fixed; right: 20px; bottom: calc(var(--gap) + var(--size) + 12px);
      width: 360px; height: 600px; display: none;
      background:#fff; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); z-index: 9998;
    }
    #chat-launcher{
      position: fixed; right: var(--gap); bottom: var(--gap);
      width: var(--size); height: var(--size); border-radius: 50%; border: none; cursor: pointer; z-index: 9999;
      box-shadow: 0 6px 20px rgba(0,0,0,.25); background: var(--fab); color: #fff; font-size: 22px;
      display: inline-flex; align-items: center; justify-content: center; transition: opacity .25s ease, transform .25s ease;
    }
    #chat-launcher.hidden{ opacity: 0; pointer-events: none; transform: translateY(10px); }

    @media (max-width: 480px){
      #chat-shell{ width: 100vw; height: 70vh; right: 0; left: 0; bottom: 0; border-radius: 12px 12px 0 0; }
      #chat-launcher{ bottom: 28px; }
    }

    header{ padding: 18px 20px; border-bottom: 1px solid #eef2f6; }
    main{ padding: 20px; }
  </style>
</head>
<body>
  <header>
    <h1>ISTHMUS</h1>
    <p>Asesor virtual de Admisiones.</p>
  </header>
  <main>
    <p>Abre el chat abajo a la derecha.</p>
  </main>

  <div id="chat-shell" role="dialog" aria-modal="true">
    <openai-chatkit id="isthmus-chat" class="h-[600px] w-[360px]"></openai-chatkit>
  </div>
  <button id="chat-launcher" aria-label="Abrir chat" aria-controls="chat-shell" aria-expanded="false">💬</button>

  <script>
  (function(){
    const SESSION_URL = "/api/chatkit/session";
    const TOOLS_BASE  = "/tools";

    const shell  = document.getElementById("chat-shell");
    const comp   = document.getElementById("isthmus-chat");
    const fab    = document.getElementById("chat-launcher");
    const MOBILE = matchMedia("(max-width:480px)").matches;

    // ID estable por navegador
    const key = "ck_device_id";
    let deviceId = localStorage.getItem(key);
    if (!deviceId) {
      deviceId = (self.crypto?.randomUUID && crypto.randomUUID()) || String(Date.now());
      localStorage.setItem(key, deviceId);
    }

    // HTTP helper: NO lanza excepción; retorna {ok:boolean, ...}
    async function postJSON(url, payload){
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      let data = {};
      try { data = await r.json(); } catch {}
      if (!r.ok) return Object.assign({ ok:false }, data, { status:r.status });
      return Object.assign({ ok:true }, data);
    }

    // Token efímero
    async function getClientSecret(current){
      const r = await fetch(SESSION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: deviceId, currentClientSecret: current || null })
      });
      if (!r.ok) {
        const txt = await r.text().catch(()=> "");
        throw new Error("session "+r.status+": "+txt);
      }
      const j = await r.json();
      return j.client_secret;
    }

    // “Todos son leads”: tras schedule_visit auto-crear lead calificado.
    async function autoCreateLeadFromVisit(clean, noteExtra){
      const lang = (navigator.language || "es").toLowerCase().startsWith("es") ? "es" : "en";
      const payload = {
        full_name: clean?.contact?.name || "Sin nombre",
        email:     clean?.contact?.email || "",
        phone:     clean?.contact?.phone || "",
        program_interest: clean?.program_interest || "no_especificado",
        language: lang,
        source_channel: "web",
        consent_personal_data: "yes",
        privacy_ack: "yes",
        costs_email_requested: "no",
        notes: `Lead auto-creado por cita (visit_qualified). ${noteExtra||""}`.trim()
      };
      const r = await postJSON(TOOLS_BASE + "/create_lead", payload);
      if (!r.ok) console.warn("auto-create_lead failed:", r);
      return r.ok;
    }

    // Devuelve SIEMPRE una cadena → evita crash del widget
    async function onClientTool({ name, params }) {
      const { tool, ...clean } = params || {};

      if (name === "create_lead") {
        // Pre-validación (evita 400 y permite al modelo pedir el campo faltante)
        const missing = [];
        if (!clean.full_name)        missing.push("full_name");
        if (!clean.email)            missing.push("email");
        if (!clean.phone)            missing.push("phone");
        if (!clean.program_interest) missing.push("program_interest");
        if (!clean.consent_personal_data) missing.push("consent_personal_data");
        if (!clean.privacy_ack)          missing.push("privacy_ack");
        if (!clean.language)             missing.push("language");
        if (!clean.source_channel)       missing.push("source_channel");
        if (!clean.costs_email_requested) missing.push("costs_email_requested");
        if (missing.length) return `error:missing_${missing[0]}`;

        const resp = await postJSON(TOOLS_BASE + "/create_lead", clean);
        return resp.ok ? "create_lead: ok" : `error:${resp.error||resp.status||"lead_failed"}`;
      }

      if (name === "schedule_visit") {
        // Pre-validación mínima
        if (!clean.modality) return "error:missing_modality";
        if (!clean.preferred_dt_local) return "error:missing_preferred_dt_local";
        if (!clean.contact?.name || !clean.contact?.email || !clean.contact?.phone) {
          return "error:missing_contact_fields";
        }
        // 1) Registrar cita
        const resp = await postJSON(TOOLS_BASE + "/schedule_visit", clean);
        const eid  = resp && resp.eventId ? ` (${resp.eventId})` : "";

        if (resp.ok) {
          // 2) Auto-lead calificado
          await autoCreateLeadFromVisit(clean);
          return `schedule_visit: ok${eid}`;
        } else {
          // Fallback: dejar lead para seguimiento manual
          await autoCreateLeadFromVisit(clean, "Registro automático falló; confirmar manual.");
          return `error:${resp.error||resp.status||"visit_failed"}`;
        }
      }

      return "error:tool_not_implemented";
    }

    async function ensureReady(){
      if (!customElements.get("openai-chatkit")) {
        await customElements.whenDefined("openai-chatkit");
      }
      comp.setOptions({
        api: { getClientSecret },
        onClientTool,
        locale: "es",
        composer: { placeholder: "Pregúntame por programas, requisitos o agenda una visita…" },
        startScreen: {
          greeting: "¡Hola! Soy el asesor virtual de Admisiones de ISTHMUS. ¿Cómo te llamas?",
          prompts: [
            { label: "Conocer Arquitectura", prompt: "Quiero información del programa de Arquitectura.", icon: "search" },
            { label: "Costos por correo",    prompt: "Envíenme los costos por correo, por favor.",       icon: "write"  },
            { label: "Agendar visita",       prompt: "Quiero agendar una visita al campus.",             icon: "calendar" }
          ]
        },
        theme: {
          colorScheme: "light",
          color: { accent: { primary: "#0b5d3f", level: 2 } },
          radius: "round",
          density: "normal"
        }
      });
    }

    function showShell(show){
      shell.style.display = show ? "block" : "none";
      fab.classList.toggle("hidden", show);
      fab.setAttribute("aria-expanded", String(show));
    }

    let configured = false;
    fab.addEventListener("click", async () => {
      try {
        const isOpen = shell.style.display === "block";
        if (isOpen) { showShell(false); return; }
        if (!configured) { await ensureReady(); configured = true; }
        showShell(true);
        if (MOBILE && !isOpen)
          setTimeout(()=>{ if (shell.style.display !== "block") fab.classList.add("hidden"); }, 5000);
      } catch (e) {
        console.error("Error al iniciar el chat:", e);
        alert("No pude iniciar el chat. Si usas bloqueadores, desactívalos para este sitio.");
      }
    });

    window.addEventListener("unhandledrejection", (e) => {
      console.error("ChatKit error:", e.reason);
      // No alert agresivo aquí; el modelo puede recuperarse del string de error.
    });
  })();
  </script>
</body>
</html>
