<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Isthmus · Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- ChatKit runtime -->
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>

    <!-- Verificación de dominio -->
    <meta name="chatkit:domain_public_key" content="domain_pk_68e7da3b8b38819099c41f6a597d5cdf00560b7a3fd09ef4" />

    <style>
      :root{
        --fab:#0b6b3a; /* verde oscuro */
        --shadow: 0 12px 30px rgba(0,0,0,.25);
      }
      *{box-sizing:border-box}
      body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:#f6f8fb; }

      /* Botón flotante */
      #chat-launcher{
        position: fixed; right: 16px; bottom: calc(16px + env(safe-area-inset-bottom, 0px));
        width:56px; height:56px; border:none; border-radius:50%;
        background:var(--fab); color:#fff; font-size:22px; cursor:pointer; z-index:9999;
        box-shadow: 0 6px 20px rgba(0,0,0,.2);
        transition: opacity .18s ease, transform .18s ease, visibility .18s ease;
      }

      /* Contenedor del chat */
      #chat-shell{
        position: fixed; right: 20px; bottom: 88px; width: 360px; height: 600px; z-index: 9998; display: none;
        background:#fff; border-radius:12px; overflow:hidden; box-shadow: var(--shadow);
      }

      /* Botón de cerrar dentro del chat */
      #chat-close{
        position:absolute; top:8px; right:8px; width:36px; height:36px;
        border:none; border-radius:9999px; background:rgba(0,0,0,.55); color:#fff;
        font-size:20px; line-height:36px; text-align:center; cursor:pointer; z-index:10000; display:none;
      }
      .open #chat-close{ display:block; }

      @media (max-width: 480px){
        #chat-shell{ width:100vw; height:70vh; right:0; left:0; bottom:0; border-radius:0; }
      }
    </style>
  </head>
  <body>
    <div id="chat-shell" aria-hidden="true">
      <button id="chat-close" aria-label="Cerrar chat" title="Cerrar">×</button>
      <openai-chatkit id="isthmus-chat" class="h-[600px] w-[360px]"></openai-chatkit>
    </div>
    <button id="chat-launcher" aria-label="Abrir chat" title="Abrir chat">💬</button>

    <script>
      // Endpoints del MISMO servidor (Railway)
      const SESSION_URL = "/api/chatkit/session";
      const TOOLS_BASE  = "/tools";

      // DOM
      const shell   = document.getElementById("chat-shell");
      const el      = document.getElementById("isthmus-chat");
      const fab     = document.getElementById("chat-launcher");
      const closer  = document.getElementById("chat-close");
      const MOBILE_Q = window.matchMedia("(max-width: 480px)");

      // ID estable por navegador
      const deviceIdKey = "ck_device_id";
      let deviceId = localStorage.getItem(deviceIdKey);
      if (!deviceId) {
        deviceId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
        localStorage.setItem(deviceIdKey, deviceId);
      }

      // Helpers de red
      async function postJSON(url, payload){
        try{
          const r = await fetch(url,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
          const data = await r.json().catch(()=> ({}));
          if(!r.ok) return { ok:false, http_status:r.status, ...data };
          return data;
        }catch{
          return { ok:false, error:"client_fetch_error" };
        }
      }
      async function getClientSecret(){
        const res = await fetch(SESSION_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ userId: deviceId })
        });
        if(!res.ok) throw new Error("No se pudo crear la sesión");
        const { client_secret } = await res.json();
        return client_secret;
      }

      // FAB show/hide
      function hideFab(){ fab.style.opacity="0"; fab.style.visibility="hidden"; fab.style.pointerEvents="none"; fab.style.transform="scale(.92)"; }
      function showFab(){ fab.style.opacity=""; fab.style.visibility=""; fab.style.pointerEvents=""; fab.style.transform=""; }
      let hideTimer = null;

      // Montaje SEGURO del web component
      let configured = false;
      async function ensureChatConfigured(){
        if (configured) return;
        if (!customElements.get("openai-chatkit")) {
          await customElements.whenDefined("openai-chatkit");
        }
        el.setOptions({
          api: { getClientSecret },

          // ⬇️ Nueva forma: manejar client tools con un callback
          async onClientTool({ name, params }) {
            switch (name) {
              case "create_lead":
                return await postJSON(TOOLS_BASE + "/create_lead", params);
              case "schedule_visit":
                return await postJSON(TOOLS_BASE + "/schedule_visit", params);
              default:
                throw new Error(`Herramienta no implementada en cliente: ${name}`);
            }
          },

          locale: "es",
          composer: { placeholder: "Pregúntame por programas, requisitos o agenda una visita…" },
          startScreen: {
            greeting: "¡Hola! Soy el asesor virtual de Admisiones de ISTHMUS. ¿Cómo te llamas?",
            prompts: [
              { label:"Conocer Arquitectura", prompt:"Quiero información del programa de Arquitectura.", icon:"search" },
              { label:"Costos por correo",    prompt:"Envíenme los costos por correo, por favor.",       icon:"write"  },
              { label:"Agendar visita",       prompt:"Quiero agendar una visita al campus.",            icon:"calendar"}
            ]
          },

          // Tema: valor fijo válido (evita primaria vacía)
          theme: {
            color: { accent: { primary: "#0b6b3a", level: 2 } },
            radius: "round",
            density: "normal"
          }
        });
        configured = true;
      }

      // Abrir / cerrar
      async function openChat(){
        await ensureChatConfigured();
        shell.style.display = "block";
        shell.classList.add("open");
        shell.setAttribute("aria-hidden","false");
        showFab();
        if (hideTimer) clearTimeout(hideTimer);
        if (MOBILE_Q.matches) hideTimer = setTimeout(hideFab, 5000); // auto-oculta en móvil
      }
      function closeChat(){
        shell.style.display = "none";
        shell.classList.remove("open");
        shell.setAttribute("aria-hidden","true");
        if (hideTimer) clearTimeout(hideTimer);
        showFab();
      }

      fab.addEventListener("click", async () => {
        try{
          const open = shell.style.display === "block";
          if (open) closeChat(); else openChat();
        }catch(e){
          console.error("Error abriendo el chat:", e);
          alert("No se pudo iniciar el chat. Intenta nuevamente.");
        }
      });
      closer.addEventListener("click", closeChat);

      // Reaplica en cambios de tamaño/orientación (Android + teclado)
      ["resize","orientationchange"].forEach(ev =>
        window.addEventListener(ev, () => {
          const open = shell.style.display === "block";
          if (open) { showFab(); if (MOBILE_Q.matches){ if (hideTimer) clearTimeout(hideTimer); hideTimer = setTimeout(hideFab, 5000); } }
          else showFab();
        })
      );
    </script>
  </body>
</html>

